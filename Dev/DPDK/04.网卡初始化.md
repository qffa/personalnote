# 网卡初始化

1. 创建一个`mbuf_pool`
2. 配置队列个数以及接口的配置信息：`rte_eth_dev_confgure`
3. 使用创建的`mbuf_pool`初始化每个接收队列：`rte_eth_rx_queue_setup`
4. 初始化发送队列：`rte_eth_tx_queue_setup`
5. 启动设备：`rte_eth_dev_start`
6. 启用混杂模式：`rte_eth_promiscuous_enable()`


## 相关对象

端口

- port

收发队列

- rx_ring
- tx_ring

dma描述符队列

- tx_desc
- rx_desc

## 配置端口

**端口配置函数**

```
int rte_eth_dev_configure(uint16_t port_id,
        uint16_t nb_rx_queue,   /* The number of receive queues*/
        uint16_t nb_tx_queue,   /* The number of transmit queues */
        const struct rte_eth_conf *eth_conf);
```
功能

- 设置接收队列数
- 设置发送队列数
- 设置网卡功能参数

**设置端口示例**

```
static const struct rte_eth_conf port_conf_default = {
  .rxmode = {
    .max_rx_pkt_len = ETHER_MAX_LEN,
    .ignore_offload_bitfield = 1,
  },
};

struct rte_eth_conf port_conf = port_conf_default;
const uint16_t rx_rings = 1, tx_rings = 1;
uint16_t nb_rxd = RX_RING_SIZE;
uint16_t nb_txd = TX_RING_SIZE;

rte_eth_dev_info_get(port, &dev_info);
if (dev_info.tx_offload_capa & DEV_TX_OFFLOAD_MBUF_FAST_FREE)
  port_conf.txmode.offloads |=
    DEV_TX_OFFLOAD_MBUF_FAST_FREE;

retval = rte_eth_dev_configure(port, rx_rings, tx_rings, &port_conf);
if (retval != 0)
	return retval;

/*
 * Check that numbers of Rx and Tx descriptors satisfy
 * descriptors limits from the ethernet device information,
 * otherwise adjust them to boundaries.
 */
retval = rte_eth_dev_adjust_nb_rx_tx_desc(port, &nb_rxd, &nb_txd);
if (retval != 0)
	return retval;
```



## 队列初始化

>每张网卡的tx/rx descriptor是确定的，所有port的队列共享这些descriptor
rte_eth_rx_queue_setup和rte_eth_tx_queue_setup允许具体分配每个队列占用的descriptor数量，初步实现基于队列的Qos

**设置发送队列函数**

```
int rte_eth_tx_queue_setup (uint16_t port_id,
        uint16_t      tx_queue_id,
        uint16_t      nb_tx_desc,  /* 分配多少个DMA描述符 */
        unsigned int  socket_id,
        const struct rte_eth_txconf *tx_conf  /* 发送队列的配置 */
)
```

**设置接收队列**

```
int rte_eth_rx_queue_setup (uint16_t port_id,
        uint16_t        rx_queue_id,
        uint16_t        nb_rx_desc,   /* The number of receive descriptors to allocate for the receive ring */
        unsigned int    socket_id,
        const struct rte_eth_rxconf *rx_conf,
        struct rte_mempool *mb_pool
)
```

**示例**

```
/* Allocate and set up 1 RX queue per Ethernet port. */
for (q = 0; q < rx_rings; q++) {
  retval = rte_eth_rx_queue_setup(port, q, nb_rxd,
      rte_eth_dev_socket_id(port), NULL, mbuf_pool);
  if (retval < 0)
    return retval;
}

txconf = dev_info.default_txconf;
txconf.txq_flags = ETH_TXQ_FLAGS_IGNORE;
txconf.offloads = port_conf.txmode.offloads;
/* Allocate and set up 1 TX queue per Ethernet port. */
for (q = 0; q < tx_rings; q++) {
  retval = rte_eth_tx_queue_setup(port, q, nb_txd,
      rte_eth_dev_socket_id(port), &txconf);
  if (retval < 0)
    return retval;
}
```


## 启动网卡

```
retval = rte_eth_dev_start(port);
if (retval < 0)
  return retval;

/* Enable RX in promiscuous mode for the Ethernet device. */
rte_eth_promiscuous_enable(port);
```
