# 文件描述符表

## 什么是文件描述符表

进程`task_struct`结构体的一个成员，每个文件描述符对应一个指针，指针指向一个文件表。

```
      fd table

    +----------+                 file table
 0  |          |
    +----------+              +--------------+
 1  |          |     +------> |     flag     |          v node table
    +----------+     |        +--------------+
 2  |          |     |        |   position   |
    +----------+     |        +--------------+         +------------+
 3  |          | +---+        |   v_pointer  | +-----> |   func     |
    +----------+              +--------------+         +------------+
 4  |          |              |    ...       |         |   i_node   |
    +----------+              +--------------+         +------------+
 5  |          |                                       |   length   |
    +----------+                                       +------------+
 6  |          |                                       |   ...      |
    +----------+                                       +------------+
..  |          |
    +----------+
 n  |          |
    +----------+

```

**文件表**

- flag：文件状态标志，即`O_RDONLY`, `O_RDWR`等
- position：文件读写置位

**V节点表**

- func：函数指针，指向用于操作文件的底层函数
- i_node：从磁盘拷贝过来的i-node信息
- length：文件长度

vnode与VFS有关
https://www.linuxquestions.org/questions/linux-kernel-70/difference-between-inode-and-vnode-657954/


## 两个有关标志位

**O_APPEND**

功能：
open文件时，如果指定了`O_APPEND`状态标志，表示以追加的方式打开文件

实现原理：
每次调用`write`之前，都会把“文件读写位置”设置为“文件的长度”

**O_TRUNC**

open打开文件时，将文件清空，v节点中的文件长度置零。当然文件系统也会对磁盘进行一系列操作。

## 理解文件描述符

1. 文件表记录着打开的文件、打开方式、读写位置以及v节点的指针
2. 文件描述符就是（对应）一个指针，指向文件表
3. 文件操作时，主要调整的是文件表，文件描述符不过是文件表的编号
4. 每打开一次文件，就会创建一个文件表，并附带着分配id，即文件描述符
5. 文件描述符的复制与继承，并不会创建新的文件表，只是简单的指针复制
