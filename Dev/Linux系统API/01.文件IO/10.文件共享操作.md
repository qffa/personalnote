# 文件共享操作

## 同一进程共享操作同一个文件

**两次open同一个文件**

```
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

# define FILE_NAME "./file.txt"

void print_error(char *str)
{
    perror(str);
    exit(-1);
}

int main(void)
{
    int fd1 = 0;
    int fd2 = 0;

    fd1 = open(FILE_NAME, O_RDWR|O_TRUNC);
    if (-1 == fd1) {
        print_error("1 open fail");
    }

    fd2 = open(FILE_NAME, O_RDWR|O_TRUNC);
    if (-1 == fd2) {
        print_error("2 open fail");
    }
    printf("fd1 = %d, fd2 = %d\n", fd1, fd2);

    while (1) {
        write(fd1, "hello\n", 6);
        sleep(1);
        write(fd2, "world\n", 6);
    }

    return 0;
}
```

文件内容被覆盖

**文件表状态**

```
      fd table

    +----------+                        file table
 0  |          |
    +----------+                     +--------------+
 1  |          |          +--------> +     flag     |
    +----------+          |          +--------------+                v node table
 2  |          |          |          |   position   |
    +----------+          |          +--------------+
 3  |          | +--------+          |   v_pointer  | +-----------> +------------+
    +----------+                     +--------------+        +----> |   func     |
 4  |          | +--------+          |    ...       |        |      +------------+
    +----------+          |          +--------------+        |      |   i node   |
 5  |          |          |                                  |      +------------+
    +----------+          |          +--------------+        |      |   length   |
 6  |          |          +--------> |    flag      |        |      +------------+
    +----------+                     +--------------+        |      |   ...      |
..  |          |                     |   position   |        |      +------------+
    +----------+                     +---+----------+        |
 n  |          |                     |   v pointer  | +------+
    +----------+                     +---+----------+
                                     |    ...       |
                                     +--------------+

```

**覆盖原因**

两个文件描述符对应着独立的文件表，文件表有属于自己的文件位移量。

**解决办法**

open时添加`O_APPEND`标志，每次`write`前定位到文件长度位置。

```
fd1 = open(FILE_NAME, O_RDWR|O_TRUNC|O_APPEND);
```


## 不同进程操作同一个文件

同样会覆盖数据，使用`O_APPEND`同样可以解决

**文件描述符表状态**

```
   proc1 fd table

    +----------+
 0  |          |
    +----------+                        file table
 1  |          |
    +----------+                     +--------------+
 2  |          |          +--------> |     flag     |
    +----------+          |          +--------------+
 3  |          | +--------+          |   position   |
    +----------+                     +--------------+
 4  |          |                     |   v_pointer  | +--------+
    +----------+                     +--------------+          |               v node table
..  |          |                     |    ...       |          |
    +----------+                     +--------------+          |
                                                               +------------> +------------+
                                                                              |   func     |
                                                               +------------> +------------+
   proc2 fd table                                              |              |   i node   |
                                     +--------------+          |              +------------+
    +----------+          +--------> |    flag      |          |              |   length   |
 0  |          |          |          +--------------+          |              +------------+
    +----------+          |          |   position   |          |              |   ...      |
 1  |          |          |          +---+----------+          |              +------------+
    +----------+          |          |   v pointer  | +--------+
 2  |          |          |          +---+----------+
    +----------+          |          |    ...       |
 3  |          | +--------+          +--------------+
    +----------+
 4  |          |
    +----------+
..  |          |
    +----------+

```
