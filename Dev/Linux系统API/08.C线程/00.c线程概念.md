# C线程概念

## 线程

在上世纪60年代，也就是操作系统刚问世不久时，那个时候的OS只有进程没有线程，直到到了80年代才开始
有了线程。

主要原因是人们开始发现，进程有缺点，为了弥补进程的缺点，就发明了线程。

**进程的缺点**

1. 进程间切换的计算机资源开销很大，切换效率非常低
2. 进程间数据共享的开销也很大

**多进程使用场景**

1. 创建子进程，执行新程序
2. 创建子进程得到多进程，通过多进程并发实现多线任务


**线程的特点**

1. 同一进程中的所以线程共享相同的内存空间，所以数据天然共享
2. 线程切换开销很低，没有进程切换时的虚拟内存切换开销
3. 进程间的数据是天然共享的，所以数据保护是个问题

**线程自己的独立属性**

进程中的所有线程会共享进程提供资源（全局变量、工作目录、打开的文件描述符、子函数等等），但是每个线程作为一个单独的执行体，也有属于自己的独立的东西。

- 每个线程拥有自己独立的线程ID（TID）
- 每个线程有独立的切换状态
- 有自己独立的函数栈
- 自己独立的错误号
- 每一个线程有自己独立的信号屏蔽字和未决信号集
- 每个线程有自己独立的tack_struct结构体





## 线程代码示例

线程以函数方式启动

```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>


/* 线程函数 */
void *pth_fun(void *pth_arg)
{
        while (1) {
                printf("1111.....\n");
                sleep(1);
        }

        return NULL;
}

int main(void)
{
        pthread_t tid = 0;  /* 线程id */
        pthread_create(&tid, NULL, pth_fun, NULL);

        // 主线程不能死，主线程死了，次线程也会跟着死 //
        while (1) {
                printf("222....\n");
                sleep(3);
        }

        return 0;
}
```

## 线程控制函数

实现多进程的时候有进程控制，进程控制涉及到的函数有`fork`、`exec`、`wait`、`exit`等函数，实现多线程的时候同样有线程控制函数，这些线程控制函数有：

`pthread_create`、`pthread_join`、 `pthread_detach`、`pthread_cancel`、`pthread_exit`


>原本线程函数也可以完全由OS来实现，但是后来为了不给OS增加负担，同时也为了提高线程的灵活性，后来的线程就不在由OS提供，而是由单独的线程库来提供，不过线程库在实现时，也是调用了相应的系统API的，也就是说线程的核心实现也是离不开OS支持的。

**线程库**

1. C线程库
  由c线程库提供，这个c线程库并不是C标准库，而是POSIX C库的一部分
  windows下也支持c线程库

2. java、c++、c#的线程函数
  由他们自己的线程库来实现的


**线程库和OS系统API的关系**

线程库函数实际上也是封住OS的相应API来实现的，如果线程库运行在Linux这边的话，线程库其实就是通过调用Linux的`clone()`等系统函数实现的。
