# 程序的加载和运行

编译得到可执行目标文件后，就可以将可执行目标文件加载到运行地址所指的内存位置，然后将PC指向程序入口地址，开始运行。基于裸机和操作系统会有所不同。

## 裸机情况

使用专门针对裸机的编译器来编译程序，最后得到的就是可以在裸机上运行的可执行程序。 加载裸机程序时，由专门的加载程序（加载软件）来实现的。

**加载**

加载的过程就是将“代码段”和“数据段”复制到内存上。

裸机时，链接器重定位后的“运行地址”是真实的物理地址，加载时直接将“代码段”和“数据段”复制到物理内存中“运行地址”所指定的位置

**运行**

1. CPU的PC寄存器存放第一条指令`_start`的地址
2. 从`_start`开始执行启动代码
3. 启动代码调用`_init`等函数进行初始化，例如开辟堆、栈
4. 启动代码调用`main`函数
5. `main`函数调用各个子函数
6. 代码运行结束后，`main`函数调用`return`返回到启动代码
7. 结束（裸机情况下main函数的返回值没有意义）

## 有OS的情况

**程序的加载**

1. 首先从父进程复制`fork`出一个子进程，也就是复制出“虚拟内存”的相关数据结构
2. 调用加载器`execve`，将新程序的“代码段”和“数据段”等复制到子进程的虚拟内存空间中

实际环境中，还会涉及到虚拟内存、缺页中断等等

**运行**

1. CPU的PC寄存器指向`_start`
2. 从`_start`开始执行代码
3. 启动代码调用`init`进行初始化，如开辟堆、栈
4. 启动代码调用`main`函数
5. `main`函数调用子函数
6. 程序执行完毕`main`函数调用`return`返回到启动代码
7. 启动代码调用`exit`将`main`函数的返回值返回给OS
8. 结束
