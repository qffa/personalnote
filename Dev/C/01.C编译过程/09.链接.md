# 链接

## 什么是链接

简单理解，链接的过程，就是将所有的`.o`文件合并为一个可执行文件的过程。链接程序`collect2`, `ld`，将所有的可重定位目标文件静态链接在一起，就得到了可执行目标文件。相关任务：

- `.o`的合并
- 加入启动代码
- 链接静态库、动态库

静态链接动态库时，只是留下函数的接口，当程序运行时再动态加载动态库

链接程序主要完成

- 符号解析
- 地址重定位

## 符号解析

**符号解析的目的**

确定模块中引用的每个符号都有明确的定义，并将每个符号的引用与定义关联起来。

**如何进行符号解析**

检查模块（`.o`）的`.symtab`符号表，看符号的定义情况

1. 符号在本模块定义，本模块符号表已经记录了本地符号的所有信息，直接关联即可，连接程序不需要做太多解析工作
2. 符号在本模块引用但是在其他模块定义，也就是本模块中的`UND`符号。链接程序去其他模块符号表中去找，找到后，将符号的引用和定义关联起来，找不到就报错

**全局符号重名问题**

不同模块中定义了名称相同的全局变量或`extern`函数，链接程序依据**强弱符号**共存规则来处理

## 强弱符号

**强弱符号的概念**

全局变量

- 强符号：初始化了的全局变量
- 弱符号：未初始化的全局变量

函数

- 强符号：函数定义
- 弱符号：函数声明

**强弱符号共存规则**

1. 不允许多个同名强符号存在，存在就报错
2. 强符号只有一个，其他都是弱符号的话，统一时，选强符号，舍弃弱符号
3. 没有强符号，都是弱符号时，留其中一个，其他舍弃，留哪个由链接程序决定

**例子**

file: a.c

```
/* a.c */

int a = 100;

int fun(){
    a += 10;
}

int main(){
    static int a = 10;
    fun();
}
```

file:b.c

```
/* b.c */

int a = 200;

extern int fun(){
    a = a- 100;
}
```

问题：`a`和`fun`都是全局强符号，链接是报重复定义的错误

解决方案一：

```
//某个强符号变弱符号

int a = 100; ---> int a;
int fun(){...} ---> int fun();
```

解决方案二：

```
//使用static解决

int a = 100; ---> static int a = 200;
int fun(){...} ---> static int fun(){...};
```

**模块内符号重名**
模块内符号重名依然遵循强弱符号原则。

**声明与定义**
声明与定义本质上是强弱符号的关系
