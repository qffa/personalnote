# C变量和函数的作用域

## 作用域
作用域就是变量和函数起作用的范围，只要在这个范围内，你就可以访问该变量和函数

**三种作用域**

- 局部变量的代码块作用域
- 函数和全局变量的本文件作用域
- 跨文件作用域 - 链接域

## 代码块作用域

**代码块**

简单理解`{` `}`括起来的就是代码块。不过结构体的`{` `}`不是代码块

**作用范围**

代码块作用域从定义处开始到代码块结束

```
int main (void)
{
    int a;      //------ a start -----
    {   
        ...;
        int b;  //------ b start -----
        ...;

    }          // ------ b end ------

}              // ------ a end ------
```

**形参作用域**

从定义位置开始，到参数列表末尾，再到函数结束

```
int fun(int n, int buf[][n])
{
    ...
}
```

如果反过来的话`fun(int buf[][n]，int n)`，就会报错

## 本文件作用域

**作用范围**

从定义开始到文件结束

```
int main(void)                 //main的本文件作用域：从定义位置到文件末尾
{                   
    fun(g_var1, g_var2);                    
    return 0;
}

int g_var1 = 100;               //g_var的本文件作用域：从定义位置到文件末尾
int g_var2;                     

int fun(int a, int b)           //fun的本文件作用域：从定义位置到文件末尾       
{                                                                                          
    return b + a;                                              
}
```

**通过声明将作用域提前**

```
int g_var1;
int g_var2;

int fun(int a, int b);

int main(void)    
{
    fun(g_var1, g_var2);
    return 0;
}

int g_var1 = 100;    
int g_var2;

int fun(int a, int b)    
{

    return b + a;
}
```

**声明与定义**

声明与定义的关系就是强弱符号的关系

定义与声明的符号名是相同的，编译时同名符号必须进行统一，然后合并为一个。

- 不能允许重复出现同名的强符号，但是允许重复出现有同名的弱符号
- 有一个强符号，其它都是弱符号的话，只保留强符号，其它弱符号消失
- 全都是弱符号的话，只留一个即可，其它全部消失


**函数内声明全局变量**

声明来自于其他文件的全局变量，必须带`extern`关键字，将该全局变量控制在函数内有效。

```
int main(void)    
{
    extern int g_var1;      //声明来自于其他文件的g_var1，extern不可以省略  
    extern int fun(int a);  //声明函数
    g_var1 = 100;

    fun(1);

    printf("%d\n", g_var1);
}
```

## 链接域

对于**全局变量**和**函数**来说，有时不仅仅只希望在本文件可以被使用，还希望在其它的文件中也能被使用，此时作用域就必须跨越到其它文件中，这就所谓的涉及跨文件作用域.

**使用链接域**

- 定义符号时，用`extern`标识为全局符号
- 在其他文件声明，声明时也需要标记为`extern`

**例子**

```
/* a.c */
extern int a;
extern int fun();
int main (void) {
    ...
}

/* b.c */
int a = 100;

int fun() {
    ..  
}
```

**注意事项**

- `extern`可以省略，省略后默认就是`extern`的，与`auto`有点像。

- 对于几乎所有的编译器来说，都认可在定义时将`extern`省略，但是对于声明来说，有些编译其允许省略`extern`但是有些就不允许，gcc就允许声明时省略`extern`

- **重点**：为了保证不出错，经常的做法是，定义时省略`extern`，但是声明时必须保留`extern`


**其他**

- `estern`修饰的符号是所有文件都可见的全局符号，为了避免同名全局变量冲突，应使用`static`关键字避免这个问题

- `static`将符号变为本地符号，其实就是关闭链接域，或者说关闭符号的跨文件作用域，符号此时只剩下本文件作用域
