# InnoDB存储引擎逻辑存储结构

InnoDB存储引擎逻辑存储结构可分为5级：

表空间（tablespace） > 段（segment） > 区（extent） > 页（page） > 记录（row）



## 表空间

从InnoDB存储引擎的逻辑存储结构看，所有数据都被逻辑地存放在一个空间中，称之为表空间(tablespace)

从功能上来看，InnoDB存储引擎的表空间分为
- 系统表空间
- 独占表空间
- 通用表空间
- 临时表空间
- Undo表空间


表空间：
- https://cloud.tencent.com/developer/article/1358159


**配置文件**

为每个表空间分配独立文件

```
innodb_file_per_table = 1  #置零关闭
```

- 开启独立表空间：每张表一个单独的.ibd文件
- 关闭独立表空间：所有基于InnoDB存储引擎的表数据都会记录到系统表空间，文件名为ibdata1

**表空间内容**

一个用户表空间由很多个段组成，基于B+树，InnoDB要求表必须有一个主键索引

- 叶子结点段（数据段）
- 非叶结点段（索引段）
- 回滚段

## 段

一个段会包含多个区，至少会有一个区，段扩展的最小单位是区


- 创建索引时，会创建两个段：数据段和索引段
- 段的空间是随着表的大小自动扩展的，表有多大段就有多大




## 区

一个区由64个连续的页组成，一个区的大小为1M（64个页，一个页16k）

为了保证区中页的连续性，区扩展时InnoDB存储引擎会一次性从磁盘中申请4~5个区

## 页

**InnoDB层**

- InnoDB每个页默认大小为16k
- 页是InnoDB管理磁盘的最小单位
- 页是InnoDB中磁盘和内存交互的最小单位，内存中存的是一个一个的页
- 索引树上一个结点就是一个页，相当于一个结点中有多个 **记录**
- MySQL规定一个页上最少存储2个数据项？


>如果向一个页插入数据时，这个页已将满了，就会从区中分配一个新页。
如果向索引树叶子节点中间的一个页中插入数据，如果这个页是满的，就会发生页分裂

**OS层**

- OS文件系统将磁盘分为块
- 块是OS读写磁盘的最小单位
- Linux中磁盘块一般是4k

*写入磁盘时，注意操作系统缓存*

**查看页大小**

```
[root@localhost][(none)]> show variables like '%innodb_page_size%';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_page_size | 16384 |
+------------------+-------+
1 row in set (0.01 sec)
```

**重点**

磁盘上的一个页和内存中的一个叶子结点一一对应

## 记录

表中的一行数据

- trx_id
- roll_pointer
- Col1
- Col2
- Col3
...


**注意**：mysql会为每行数据添加事务ID和回滚指针
